<?php
error_reporting(E_ALL & ~E_DEPRECATED);  // ~E_DEPRECATED because mysql extension is deprecated since PHP 5.5
include '../config/config.php';
if ($pdo) {
	// Use PDO
	$database = new PDO("mysql:host=$dbHost;dbname=$dbSchema", $dbUsername, $dbPassword);
	if (isset($_GET['id'])) {
		$statement = $database->prepare('SELECT id, name, description, image FROM products WHERE id = ?');
		$statement->execute(array($_GET['id']));
	} else {
		$statement = $database->query('SELECT id, name, description, image FROM products ORDER BY name');
	}
	$rows = $statement->fetchAll(PDO::FETCH_ASSOC);
} else {
	// If you can't use PDO
	$mysqli = new mysqli($dbHost, $dbUsername, $dbPassword, $dbSchema);
	$mysqli->set_charset('utf8');
	if (isset($_GET['id'])) {
		$id = $_GET['id'];  // WRONG, vulnerable to SQL Injection attack
		$id = $mysqli->escape_string($_GET['id']);  // WRONG, still vulnerable to SQL Injection attack
		// $id = (int)$_GET['id'];  // CORRECT, SQL query expects a number not a string, that's why escaping is not enough
		$sql = "SELECT id, name, description, image FROM products WHERE id = $id";
	} else {
		$sql = "SELECT id, name, description, image FROM products ORDER BY name";
	}
	$result = $mysqli->query($sql);
	$rows = array();
	while ($row = $result->fetch_assoc()) {
		$rows[] = $row;
	}
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Exploited Products</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<style>
		.bg-exploited-dark-blue { background-color: #222638 !important; }
	</style>
</head>
<body>
	<nav class="navbar navbar-dark bg-dark bg-exploited-dark-blue">
	<img src="/img/logo_center.gif" width="467" height="26" class="d-inline-block align-top" alt="Logo">
</nav>
<main class="container p-3">
	<div class="card-columns">
	<?php foreach ($rows as $key => $row) { ?>
		<div class="card m-3">
			<img src="<?= htmlspecialchars($row['image']); ?>" class="card-img-top" alt="...">
			<div class="card-body">
				<h5 class="card-title"><?= htmlspecialchars($row['name']); ?></h5>
				<p class="card-text"><?= htmlspecialchars($row['description']); ?></p>
				<a href="?id=<?= htmlspecialchars($row['id']); ?>" class="btn btn-primary">Details</a>
			</div>
		</div>
	<?php } ?>
	</div>
</main>
</body>
</html>
